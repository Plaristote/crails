#!/usr/bin/env ruby

source = nil
source = ENV['CRAILS_SHARED_DIR'] unless ENV['CRAILS_SHARED_DIR'].nil?

if source.nil?
  (ENV['XDG_DATA_DIRS'].split ':').each do |dir|
    full_path = "#{dir}/crails"
    if File.directory? full_path
      source = full_path
      break
    end
  end
end

if source.nil?
  puts "Missing crails shared directory. Please check your installation."
  exit 1
else
  ENV['CRAILS_SHARED_DIR'] = source
end

command      = ARGV[0]
command_args = ARGV[1..ARGV.count]

unless command == 'new'
  require 'fileutils'

  until (File.exists? 'CMakeLists.txt' and File.exists? 'app' and File.exists? 'public')
    FileUtils.cd '..'
    if Dir.pwd == '/'
      puts 'You\'re not in a Crails application'
      exit -2
    end
  end
end

puts "Executing Crails script in #{Dir.pwd}"

system "ruby #{source}/scripts/#{command}.rb #{command_args.join ' '}"
